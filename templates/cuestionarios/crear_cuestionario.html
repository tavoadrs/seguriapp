{% extends 'base.html' %}

{% block title %}Crear Cuestionario{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-md p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">üìù Nuevo Cuestionario</h1>
        
        <!-- Formulario -->
        <form id="cuestionario-form" class="space-y-6">
            
            <!-- Charla 
            <div>
                <label class="block text-gray-700 font-medium mb-2">Charla</label>
                <select name="charla" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    {% for charla in charlas %}
                        <option value="{{ charla.id }}">{{ charla.tema }}</option>
                    {% endfor %}
                </select>
            </div>.  -->
            <!-- T√≠tulo -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">T√≠tulo del Cuestionario</label>
                <input type="text" name="titulo" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                       placeholder="Ej: Seguridad en alturas">
            </div>
            
            <!-- Porcentaje Aprobaci√≥n -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Porcentaje m√≠nimo para aprobar</label>
                <input type="number" name="aprobacion_minima" required min="0" max="100" value="70"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            </div>
            
            <!-- Preguntas din√°micas -->
            <div id="preguntas-container" class="space-y-4"></div>
            
            <button type="button" id="agregar-pregunta"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                ‚ûï Agregar Pregunta
            </button>
            
            <!-- Resultado -->
            <div id="form-result"></div>
            
            <!-- Bot√≥n de enviar -->
            <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                ‚úÖ Crear Cuestionario
            </button>
            <a href="/charlas/"></a>
        </form>
    </div>
</div>

<script>
let preguntaCount = 0;

// Funci√≥n para agregar pregunta
function agregarPregunta() {
    preguntaCount++;
    
    const preguntaDiv = document.createElement('div');
    preguntaDiv.classList.add('bg-gray-100', 'p-4', 'rounded-lg', 'space-y-2');
    preguntaDiv.setAttribute('data-pregunta-id', preguntaCount);
    
    preguntaDiv.innerHTML = `
        <label class="block font-medium">Pregunta ${preguntaCount}</label>
        <input type="text" name="pregunta_${preguntaCount}" required
               class="w-full px-3 py-2 border border-gray-300 rounded-lg"
               placeholder="Texto de la pregunta">
        <div class="opciones space-y-2 mt-2"></div>
        <button type="button" class="agregar-opcion bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
            ‚ûï Agregar Opci√≥n
        </button>
        <hr class="mt-3">
    `;
    
    document.getElementById('preguntas-container').appendChild(preguntaDiv);
    
    // Evento para agregar opci√≥n dentro de esta pregunta
    const botonOpcion = preguntaDiv.querySelector('.agregar-opcion');
    botonOpcion.addEventListener('click', () => agregarOpcion(preguntaDiv));
}

// Funci√≥n para agregar opci√≥n
function agregarOpcion(preguntaDiv) {
    const opcionesDiv = preguntaDiv.querySelector('.opciones');
    const preguntaId = preguntaDiv.getAttribute('data-pregunta-id');
    const opcionCount = opcionesDiv.children.length + 1;
    
    const opcionDiv = document.createElement('div');
    opcionDiv.classList.add('flex', 'items-center', 'space-x-2');
    opcionDiv.innerHTML = `
        <input type="text" name="pregunta_${preguntaId}_opcion_${opcionCount}" required
               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
               placeholder="Texto de la opci√≥n">
        <label class="flex items-center space-x-1">
            <input type="checkbox" name="pregunta_${preguntaId}_opcion_${opcionCount}_correcta">
            <span>Correcta</span>
        </label>
    `;
    opcionesDiv.appendChild(opcionDiv);
}

document.getElementById('agregar-pregunta').addEventListener('click', agregarPregunta);

// Enviar formulario
document.getElementById('cuestionario-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('charla', document.querySelector('[name="charla"]').value);
    formData.append('titulo', document.querySelector('[name="titulo"]').value);
    formData.append('aprobacion_minima', document.querySelector('[name="aprobacion_minima"]').value);
    
    // Construir preguntas y opciones
    const preguntas = [];
    document.querySelectorAll('#preguntas-container > div').forEach(pregDiv => {
        const pid = pregDiv.getAttribute('data-pregunta-id');
        const texto = pregDiv.querySelector(`input[name="pregunta_${pid}"]`).value;
        
        const opciones = [];
        pregDiv.querySelectorAll('.opciones > div').forEach((opDiv, idx) => {
            const textoOpcion = opDiv.querySelector(`input[name="pregunta_${pid}_opcion_${idx+1}"]`).value;
            const esCorrecta = opDiv.querySelector(`input[name="pregunta_${pid}_opcion_${idx+1}_correcta"]`).checked;
            opciones.push({texto: textoOpcion, es_correcta: esCorrecta});
        });
        
        preguntas.push({texto: texto, opciones: opciones});
    });
    
    formData.append('preguntas', JSON.stringify(preguntas));
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/cuestionarios/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        const result = await response.json();
        
        if (response.ok) {
            document.getElementById('form-result').innerHTML = `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                    ‚úÖ Cuestionario creado correctamente.
                </div>
            `;
            e.target.reset();
            document.getElementById('preguntas-container').innerHTML = '';
            preguntaCount = 0;
        } else {
            document.getElementById('form-result').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    ‚ùå Error: ${result.detail || JSON.stringify(result)}
                </div>
            `;
        }
    } catch (err) {
        console.error(err);
        document.getElementById('form-result').innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                ‚ùå Error de conexi√≥n
            </div>
        `;
    }
});
</script>
{% endblock %}
