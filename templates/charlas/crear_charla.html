{% extends 'base.html' %}

{% block title %}Crear Charla{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-xl shadow-md p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">ğŸ“š Nueva Charla de Seguridad</h1>
        
        <!-- Formulario -->
        <form 
            hx-post="/api/charlas/"
            hx-headers='{"Authorization": "Bearer " + localStorage.getItem("access_token")}'
            hx-target="#form-result"
            hx-swap="innerHTML"
            class="space-y-6">
            
            <!-- Tema -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Tema de la Charla</label>
                <input 
                    type="text" 
                    name="tema" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Ej: Uso correcto de EPP en altura">
            </div>
            
            <!-- Fecha -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Fecha</label>
                <input 
                    type="date" 
                    name="fecha" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Hora -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Hora</label>
                <input 
                    type="time" 
                    name="hora" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Supervisor (hidden, se obtiene del usuario actual) -->
            <input type="hidden" name="supervisor" value="{{ user.id }}">
            
            <!-- Resultado -->
            <div id="form-result"></div>
            
            <!-- Botones -->
            <div class="flex space-x-4">
                <button 
                    type="submit"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
                    âœ… Crear Charla
                </button>
                
                <a 
                    href="/charlas/"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg text-center transition">
                    âŒ Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Interceptar envÃ­o del formulario para convertir a JSON
    document.querySelector('form').addEventListener('htmx:configRequest', function(evt) {
        const formData = new FormData(evt.detail.target);
        const data = {};
        
        formData.forEach((value, key) => {
            data[key] = value;
        });
        
        // Convertir supervisor a nÃºmero
        data.supervisor = parseInt(data.supervisor);
        
        evt.detail.parameters = data;
        evt.detail.headers['Content-Type'] = 'application/json';
    });
    
    // Manejar respuesta exitosa
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'form-result') {
            if (evt.detail.xhr.status === 201) {
                const charla = JSON.parse(evt.detail.xhr.responseText);
                evt.detail.target.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        âœ… Â¡Charla creada exitosamente!
                        <div class="mt-2">
                            <a href="/charlas/${charla.id}/" class="text-green-800 font-bold hover:underline">
                                Ver charla â†’
                            </a>
                        </div>
                    </div>
                `;
                
                // Limpiar formulario
                evt.detail.target.closest('form').reset();
                
                // Redirigir despuÃ©s de 2 segundos
                setTimeout(() => {
                    window.location.href = '/charlas/';
                }, 2000);
            }
        }
    });
    
    // Manejar errores
    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.target.id === 'form-result') {
            let errorMessage = 'Error al crear la charla';
            
            try {
                const error = JSON.parse(evt.detail.xhr.responseText);
                if (error.tema) errorMessage = `Tema: ${error.tema[0]}`;
                else if (error.fecha) errorMessage = `Fecha: ${error.fecha[0]}`;
                else if (error.hora) errorMessage = `Hora: ${error.hora[0]}`;
                else if (error.supervisor) errorMessage = `Supervisor: ${error.supervisor[0]}`;
            } catch (e) {}
            
            evt.detail.target.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    âŒ ${errorMessage}
                </div>
            `;
        }
    });
</script>
{% endblock %}